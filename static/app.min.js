var WCPay=function(data,sup){WeixinJSBridge.invoke("getBrandWCPayRequest",data,(function(res){"get_brand_wcpay_request:ok"===res.err_msg?(sup?alert("下单成功！"):alert("下单成功！请看「我的个人账号」"),window.parent.closeUp(!1)):"get_brand_wcpay_request:cancel"===res.err_msg||alert("支付功能异常")}))};function fillPriceAndQtySelect(trig,evt,unit,price,off,unitx,max,stock){const url=window.location.href;let endp=url.lastIndexOf("/",url.length-1),startp=url.lastIndexOf("/",endp-1),n=parseInt(url.substring(startp+1,endp)),vip=!1;if(evt.detail){let lst=evt.detail.split("+");for(let i=0;i<lst.length;i++)if(n===parseInt(lst[i])){vip=!0;break}}let ofprice=trig.querySelector(".fprice");if(vip||off>0?(ofprice.value=(price-off).toFixed(2),ofprice.classList.add("vip")):ofprice.value=price.toFixed(2),stock<=0)return;stock<max&&(max=stock);let sel_qtyselect=trig.querySelector(".qtyselect");for(let i=unitx;i<=max;i+=unitx*(i>=100?5:i>=50?2:1)){let opt=document.createElement("option");opt.value=i,opt.text=i+" "+unit,sel_qtyselect.add(opt)}}function buyRecalc(trig){if(trig){let footer=trig.parentElement,ofprice=footer.querySelector(".fprice"),osubtotal=footer.querySelector(".subtotal"),fprice=parseFloat(ofprice.value);osubtotal.value=(trig.value*fprice).toFixed(2),0==trig.value?(osubtotal.classList.add("uk-invisible"),trig.classList.remove("uk-active")):(osubtotal.classList.remove("uk-invisible"),trig.classList.add("uk-active"))}let frm=trig?trig.form:document.forms[0];if(!frm)return;let sum=0,lst=frm.querySelectorAll(".subtotal");for(let i=0;i<lst.length;i++){let v=lst[i].value;v>0&&(sum+=parseFloat(v))}let fee=0;if(frm.fee){let ofee=frm.fee,min=parseFloat(ofee.getAttribute("min")),rate=parseFloat(ofee.getAttribute("rate")),max=parseFloat(ofee.getAttribute("max"));if(fee=Math.max(min,Math.min(sum*rate,max)),fee=parseFloat((fee-fee%.5).toFixed(1)),frm.area){let opts=frm.area.selectedOptions;if(opts.length>0){var opt=opts[0],add;if(opt.title)fee+=parseFloat(opt.title)}}frm.fee.value=fee.toFixed(1)}frm.topay&&(sum+=fee,frm.topay.value=sum.toFixed(2))}function posItemChange(trig){let form=trig.form,v=trig.selectedOptions[0],id=v.value,unit=v.getAttribute("unit"),unitw=parseFloat(v.getAttribute("unitw")),price=parseFloat(v.getAttribute("price")),avail=parseFloat(v.getAttribute("avail")),local_price=window.localStorage.getItem("pos-price-"+id);local_price&&(price=parseFloat(local_price)),form.price.value=price,form.price.setAttribute("local","pos-price-"+id),form.unit.value=unit||"",posRecalc(trig)}function posRecalc(trig){const form=trig.form;let subtotal=form.subtotal,price=form.price,qty=form.qty;subtotal.value=(qty.value*price.value).toFixed(2)}function posResum(form,round){let lst=form.querySelectorAll(".subtotal"),sum=0;for(let i=0;i<lst.length;i++)sum+=parseFloat(lst[i].innerHTML);let pay=form.pay;1===round?sum>=parseFloat(pay.value)&&(sum=Math.floor(sum)):2===round&&sum<=parseFloat(pay.value)&&(sum=Math.ceil(sum)),pay.value=sum.toFixed(2)}function posAdd(trig){const form=trig.form;if(!form||!form.reportValidity())return;let itemid=form.itemid.value,opt=form.itemid.selectedOptions[0],lotid=parseInt(opt.getAttribute("lotid")),name=opt.getAttribute("name"),unit=opt.getAttribute("unit"),unitw=opt.getAttribute("unitw"),price=parseFloat(form.price.value),qty=parseFloat(form.qty.value),subtotal=parseFloat(form.subtotal.value),tbody=document.getElementById("items"),tr=document.createElement("tr"),html='<input type="hidden" name="'+itemid+'" value="'+lotid+"-"+name+"-"+unit+"-"+unitw+"-"+price+"-"+qty+'">';html+="<td>"+name+'</td><td class="uk-text-right">'+price.toFixed(2)+'</td><td class="uk-text-right">'+qty+'</td><td class="subtotal uk-text-right">'+subtotal.toFixed(2)+'</td><td><a uk-icon="close" onclick="posRemove(this);"></a></td>',tr.innerHTML=html,tbody.appendChild(tr),posResum(form.nextElementSibling),form.reset()}function posRemove(el){let tr=ancestorOf(el,"tr"),form=ancestorOf(el,"form");tr.remove(),posResum(form)}function $smsvcode(trig){let method=trig.formMethod,action=trig.formAction||trig.name,form=trig.form;if(!form||!form.reportValidity())return!1;trig.disabled=!0;const xhr=new XMLHttpRequest;return xhr.onload=function(e){form.vcode.required=!0},xhr.open(method,action,!1),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(serialize(trig.form)),!1}function $pos(trig){let method="post",action=trig.formAction||trig.name;if(!trig.form||!trig.form.reportValidity())return!1;trig.disabled=!0;const xhr=new XMLHttpRequest;return xhr.onreadystatechange=function(){if(4===this.readyState)if(trig.disabled=!1,this.status>=200&&this.status<205){let tbody;document.getElementById("items").innerHTML="",alert("成功"),trig.form.reset()}else this.status>=500&&alert("错误，请确认库存")},xhr.open("post",action,!1),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(serialize(trig.form)),!1}function $buy(trig){let method="post",action=trig.formAction||trig.name,frm=trig.form;if(!frm||!frm.reportValidity())return!1;let any=!1,lst=frm.querySelectorAll(".qtyselect");for(let i=0;i<lst.length;i++)if(lst[i].value){any=!0;break}if(!any)return void alert("请先选择商品及件数");const xhr=new XMLHttpRequest;return xhr.onload=function(e){let data=JSON.parse(this.responseText);window.top.WCPay(data,!1)},xhr.open("post",action,!1),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(serialize(trig.form,!0)),!1}function $pur(trig){let method="post",action=trig.formAction||trig.name;if(!trig.form||!trig.form.reportValidity())return!1;const xhr=new XMLHttpRequest;return xhr.onload=function(e){if(this.responseText){let data=JSON.parse(this.responseText);window.top.WCPay(data,!0)}else alert("服务器端无返回数据")},xhr.open("post",action,!1),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(serialize(trig.form)),!1}const $=function(selectors,doc){return doc||(doc=document),doc.querySelector(selectors)},$$=function(selectors,doc){return doc||(doc=document),doc.querySelectorAll(selectors)};function ancestorOf(el,name){for(;el=el.parentElement;)if(el.classList.contains(name)||el.tagName.toLowerCase()===name)return el;return null}function childOf(el,name){for(let i=0;i<el.children.length;i++){let child=el.children[i];if(child.classList.contains(name)||child.tagName.toLowerCase()===name)return child}return null}function subscriptUri(uri,num){let a=uri.split("?"),p=a[0].length-1,dash;for(;p>0;){let c=a[0].charAt(p);if("/"===c){dash=-1;break}if("-"===c){dash=p;break}p--}if(-1===dash){let ret=a[0]+"-"+num;return a.length>1&&(ret+="?"+a[1]),ret}{let ret=a[0].substring(0,dash)+"-"+num;return a.length>1&&(ret+="?"+a[1]),ret}}function forWebview(){window.chrome.webview.addEventListener("message",(function(evt){alert(evt.data)}))}function fixAll(){let cookies={};if(document.cookie&&""!==document.cookie){let split=document.cookie.split(";");for(let i=0;i<split.length;i++){let name_value=split[i].split("=");name_value[0]=name_value[0].replace(/^ /,""),cookies[name_value[0]]=decodeURIComponent(name_value[1])}}let elst=document.querySelectorAll("[cookie]");for(let e of elst){let name=e.getAttribute("cookie");if(name){e.addEventListener("change",event=>{document.cookie=name+"="+encodeURIComponent(e.value)+";max-age=31104000"});let scpt=e.getAttribute("onfix"),val=cookies[name];if(!val)continue;if(scpt){let evt=new CustomEvent("fix",{detail:val});e.addEventListener("fix",new Function(scpt)),e.dispatchEvent(evt)}else e.value=val}}elst=document.querySelectorAll("[local]");for(let e of elst){let name=e.getAttribute("local");if(name){let scpt=e.getAttribute("onfix"),val=window.localStorage.getItem(name);if(scpt){let evt=new CustomEvent("fix",{detail:val});e.addEventListener("fix",new Function(scpt)),e.dispatchEvent(evt)}else e.value=val}e.addEventListener("change",event=>{let trig=event.target;name=trig.getAttribute("local"),name&&window.localStorage.setItem(name,trig.value)})}}function serialize(form,notEmpty){if(!form||"FORM"!==form.nodeName)return null;let i,j,q=[];for(i=form.elements.length-1;i>=0;i-=1)if(""!==form.elements[i].name)switch(form.elements[i].nodeName){case"INPUT":switch(form.elements[i].type){case"text":case"hidden":case"password":case"color":case"date":case"datetime-local":case"email":case"month":case"number":case"range":case"search":case"tel":case"time":case"url":case"week":q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].value));break;case"checkbox":case"radio":form.elements[i].checked&&q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].value))}break;case"TEXTAREA":q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].value));break;case"SELECT":if(notEmpty&&""===form.elements[i].value)break;switch(form.elements[i].type){case"select-one":q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].value));break;case"select-multiple":for(j=form.elements[i].options.length-1;j>=0;j-=1)form.elements[i].options[j].selected&&q.push(form.elements[i].name+"="+encodeURIComponent(form.elements[i].options[j].value))}}return 0===q.length?null:q.join("&")}function askSend(trig,tip,pick){if(trig.form.reportValidity()){if(pick&&!serialize(trig.form))return alert("请先勾选操作项"),!1;if(!window.confirm(tip))return!1;var method="post",action=trig.formAction||trig.name,form=trig.form;if(!form||!form.reportValidity())return!1;var xhr=new XMLHttpRequest;return xhr.onreadystatechange=function(){window.parent.setModified(),4==this.readyState&&(200==this.status||205==this.status?window.location.reload():204==this.status&&window.parent.closeUp(!0))},xhr.open("post",action,!1),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(serialize(trig.form)),!1}}function appendTo(parent,html){var e=document.createElement("div");return e.innerHTML=html,parent.appendChild(e.firstChild)}function goto(trigOrUrl,evt){var fr;(evt.preventDefault(),"A"==trigOrUrl.tagName)?("_parent"==trigOrUrl.target?window.parent:window).location.replace(trigOrUrl.href):location.replace(trigOrUrl);return!1}function markAndGo(cookieName,el){return document.cookie=cookieName+"="+el.id+";max-age=31104000",!0}function setActive(evt,el){el.id==evt.detail&&el.classList.add("uk-active")}function formRefresh(trig,evt){var b=serialize(trig.form);if(evt.preventDefault(),trig.tagName="BUTTON"){if(!trig.form.reportValidity())return;var a,url=(a=trig.formAction)+"?"+b;location.replace(url)}else{var a,url=(a=location.href.split("?"))[0]+"?"+b+(1==a.length?"":"&"+a[1]);location.replace(url)}}const SCRIPT=1,CONFIRM=2,CROP=4,PROMPT=8,SHOW=16,OPEN=32,ASTACK=64;function dialog(trig,mode,pick,title,event){event&&(event.preventDefault(),event.stopPropagation());var modalc=8==mode?" uk-modal-small":32==mode?" uk-modal-large":16==mode||4==mode?" uk-modal-tall":64==mode?" uk-modal-full":null,annimc=8==mode?"":32==mode?" uk-animation-scale-up":16==mode||4==mode?" uk-animation-slide-bottom":64==mode?" uk-animation-slide-right":null,formid=trig.form?trig.form.id:"",tag=trig.tagName,action,method="post",src,trigc;if("BUTTON"==tag){var qstr;if(action=trig.formAction||trig.name,method=trig.formMethod||method,pick){if(!serialize(trig.form))return alert("请先勾选操作项"),!1;if(!(qstr=serialize(trig.form)))return!1}64==mode&&(qstr=qstr?qstr+"&astack=true":"astack=true"),src=qstr?-1==action.indexOf("?")?action+"?"+qstr:action+"&"+qstr:action,trigc=" button-trig"}else"A"==tag&&(src=action=decodeURI(trig.href),method="get",64==mode&&(src+=-1==src.indexOf("?")?"?astack=true":"&astack=true"),src+=-1==src.indexOf("?")?"?inner=true":"&inner=true",trigc=" anchor-trig");title=title||"";var div='<div id="dialog" class="'+modalc+trigc+'" uk-modal>';div+='<section class="uk-modal-dialog uk-margin-auto-vertical'+annimc+'">',16==mode||4==mode?div+='<button class="uk-modal-close-outside uk-close" type="button" uk-icon="close" onclick="closeUp(true);"></button>':8!=mode&&32!=mode||(div+='<header class="uk-modal-header"><span class="uk-modal-title">'+title+'</span><button class="uk-modal-xclose" type="button" uk-icon="close" onclick="closeUp(true);"></button></header>'),div+='<main class="uk-modal-body uk-padding-remove"><iframe id="modalbody" src="'+src+'" style="width: 100%; height: 100%; border: 0"></iframe></main>',8==mode&&(div+='<footer class="uk-modal-footer uk-text-center"><button id="okbtn" class="uk-button uk-button-default" type="button" onclick="event.preventDefault(); return ok(this,'+mode+",'"+formid+"','"+tag+"','"+action+"','"+method+"');\" disabled>确定</button></footer>"),div+="</section></div>";var e=appendTo(document.body,div);window.addEventListener("popstate",evt=>{var dlg=$("#dialog"),ifr;dlg&&(modified?window.frameElement.contentWindow.location.reload():UIkit.modal(dlg).hide().then((function(){dlg.remove()})))});var m=UIkit.modal(e);return m.bgClose=!1,m.escClose=!1,m.show().then((function(){var srcurl=new URL(src);history.pushState(null,null,srcurl.hostname==location.hostname?action:"extern")})),!1}var modified,croppie;function setModified(){modified=!0}function genClose(trig){if(window.frameElement){var a=document.createElement('<a class="uk-icon-button uk-icon" href="javascript: window.parent.closeUp(false);" uk-icon="icon: chevron-left; ratio: 1.75">');trig.prepend(a)}}function closeUp(reload,roundtrip){var dlg=$("#dialog");if(dlg){roundtrip&&setModified();var subifr=dlg.querySelector("#modalbody"),subdlg=subifr&&subifr.contentDocument&&null!=subifr.contentDocument.querySelector("#dialog"),ifr;if(UIkit.modal(dlg).hide().then((function(){dlg.remove()})),reload&modified)window.frameElement.contentWindow.location.reload();history.go(subdlg||roundtrip?-2:-1)}}function ok(okbtn,mode,formid,tag,action,method){var div=ancestorOf(okbtn,"uk-modal");if(ifr=div.querySelector("iframe"),form=ifr.contentDocument.querySelector("form"),8==mode){if(!form||!form.reportValidity())return;if("A"==tag)(qstr=serialize(form))&&(uri=-1==action.indexOf("?")?action+"?"+qstr:action+"&"+qstr,history.back(),location.replace(uri));else if("BUTTON"==tag)if("get"==method){var qstr=serialize(form);qstr&&(UIkit.modal(div).hide().then((function(){div.remove()})),history.back(),location.replace(action.split("?")[0]+"?"+qstr))}else if("post"==method){var mform=$("#"+formid);for(var pair of new FormData(form).entries()){var hid=document.createElement("input");hid.type="hidden",hid.name=pair[0],hid.value=pair[1],mform.appendChild(hid)}UIkit.modal(div).hide().then((function(){div.remove()})),mform.setAttribute("action",action),mform.setAttribute("method",method),mform.submit()}}return!1}function crop(trig,siz,title,subs){var wid,hei,sizg,trigc="BUTTON"==trig.tagName?"button-trig":"anchor-trig",action=trig.href||trig.formAction;switch(siz){case 1:wid=120,hei=120;break;case 2:wid=480,hei=200;break;case 3:wid=480,hei=640}var h='<div id="dialog" class="uk-modal-tall '+trigc+'" uk-modal>';if(h+='<section class="uk-modal-dialog uk-margin-auto-vertical uk-animation-slide-bottom">',h+='<button class="uk-modal-close-outside uk-close" type="button" uk-icon="close" onclick="closeUp(true);"></button>',h+='<main id="imgbnd" class="uk-modal-body uk-padding-remove">',h+='<input type="file" id="imginp" style="display: none;" onchange="bind(this.parentNode, window.URL.createObjectURL(this.files[0]),'+wid+","+hei+');">',h+="</main>",h+='<footer class="uk-modal-footer">',h+='<div class="uk-button-group">',subs>0){h+='<select id="imgsub" class="uk-select uk-width-auto" style="position: absolute; left: 4px" onchange="bind($(\'#imgbnd\'),\''+action+"-' + this.value,"+wid+","+hei+');">';for(var i=1;i<=subs;i++)h+='<option value="'+i+'">'+title+" "+i+"</option>";h+="</select>"}else h+='<span class="uk-modal-title" style="position: absolute; left: 4px">'+title+"</span>";h+='<button class="uk-button uk-button-default" onclick="$(\'#imginp\').click();">选择</button>',h+='<button class="uk-button uk-button-default" onclick="cropUpd($(\'#imginp\'),'+siz+","+(0==subs?"'"+action+"', true)":"'"+action+"-' + $('#imgsub').value)")+'">保存</button>',subs>0&&(h+='<button uk-icon="bolt" class="uk-button uk-icon-button" style="position: absolute; right: 4px" onclick="bind($(\'#imgbnd\'),\''+action+"-' + $('#imgsub').value);\"></button>"),h+="</div>",h+="</footer>",h+="</section>",h+="</div>",window.addEventListener("popstate",evt=>{var dlg=$("#dialog"),ifr;dlg&&(modified?window.frameElement.contentWindow.location.reload():UIkit.modal(dlg).hide().then((function(){dlg.remove()})))});var e=appendTo(document.body,h),m=UIkit.modal(e);return m.bgClose=!1,m.escClose=!1,m.show().then((function(){history.pushState(null,null,action)})),bind($("#imgbnd"),0==subs?action:action+"-1",wid,hei),e.addEventListener("hidden",(function(){var dlg=$("#dialog");dlg&&(dlg.classList.contains("button-refresh-trig")?location.reload(!1):dlg.remove())}),!1),!1}var cropWid=0,cropHei=0,QRCode;function bind(el,url,wid,hei){if(wid&&hei)cropWid&&cropHei&&(cropWid==hei||cropHei==wid)||(cropWid=wid,cropHei=hei);else{var n=cropWid;cropWid=cropHei,cropHei=n}croppie&&croppie.destroy(),(croppie=new Croppie(el,{viewport:{width:cropWid/2,height:cropHei/2},enforceBoundary:!0,showZoomer:!1})).bind(url).then((function(){croppie.setZoom(.5)}))}function cropUpd(el,siz,url,close){croppie.result({type:"blob",size:{width:cropWid,height:cropHei},format:"webp",quality:.9}).then((function(blob){var maxk=1==siz?20:2==siz?60:120,blobk=blob.size/1024;if(blobk>maxk)alert("图片不能超过 "+maxk+"K（"+blobk+"K）");else{var dat=new FormData;dat.append("img",blob,"img.webp");var xhr=new XMLHttpRequest;xhr.open("POST",url,!1),xhr.onload=function(e){if(200==xhr.status||201==xhr.status){alert("上传成功");var dlg=ancestorOf(el,"uk-modal");dlg.classList.add("button-refresh-trig"),close&&(UIkit.modal(dlg).hide().then((function(){dlg.remove()})),history.go(-1))}},xhr.send(dat)}}))}function toggleAll(trig){var frm=trig.form,i=0;for(i=0;i<frm.elements.length;i++){var inp=frm.elements[i];"checkbox"==inp.type&&inp!=trig&&trig.checked!=inp.checked&&inp.click()}return!0}function checkToggle(trig,only,follow){var el=ancestorOf(trig,"uk-card");if(el||(el=ancestorOf(trig,"tr")),el||(el=ancestorOf(trig,"uk-accordion-title")),el||(el=ancestorOf(trig,"uk-tile")),only)for(var ul=ancestorOf(trig,"ul"),i=0;i<ul.children.length;i++){var li;(li=ul.children[i]).classList.remove("uk-active")}if(trig.checked){if(only){var frm=trig.form,i=0;for(i=0;i<frm.elements.length;i++){var inp=frm.elements[i];"checkbox"==inp.type&&inp!=trig&&inp.checked&&inp.click()}}if(el.classList.add("uk-active"),only&&follow)for(var ul=ancestorOf(trig,"ul"),cur=!1,i=0;i<ul.children.length;i++){var li=ul.children[i];cur&&follow&&childOf(li,"a")&&(li.classList.add("uk-active"),follow--),li==el&&(cur=!0)}}else el.classList.remove("uk-active")}function btnSubmit(el,chk){var form=el.form;if(form){if(form.length<=1)return;if("multipart/form-data"==form.enctype)croppie.result({type:"base64",size:"viewport",format:"webp",quality:.9}).then((function(base64){var inp=$("#img");if(inp){if(inp.value=base64,!form.reportValidity())return;el.disabled=!0,form.method=el.formMethod,form.action=el.formAction,form.submit()}}));else{if(chk){for(var ok=!1,i=0;i<form.elements.length;i++){var inp=form.elements[i];if(("checkbox"===inp.type||"radio"===inp.type)&&inp.checked){ok=!0;break}}if(!ok)return}if(!form.reportValidity())return;el.disabled=!0,form.method=el.formMethod,form.action=el.formAction,form.submit()}}}function addUp(form){for(var amt=0,i=0;i<form.elements.length;i++){var inp=form.elements[i];if(inp.checked){var li,p=childOf(ancestorOf(inp,"li"),"p"),price;amt+=parseFloat(p.textContent)}}return amt.toFixed(2)}!function(){function QR8bitByte(data){this.mode=QRMode.MODE_8BIT_BYTE,this.data=data,this.parsedData=[];for(var i=0,l=this.data.length;i<l;i++){var byteArray=[],code=this.data.charCodeAt(i);code>65536?(byteArray[0]=240|(1835008&code)>>>18,byteArray[1]=128|(258048&code)>>>12,byteArray[2]=128|(4032&code)>>>6,byteArray[3]=128|63&code):code>2048?(byteArray[0]=224|(61440&code)>>>12,byteArray[1]=128|(4032&code)>>>6,byteArray[2]=128|63&code):code>128?(byteArray[0]=192|(1984&code)>>>6,byteArray[1]=128|63&code):byteArray[0]=code,this.parsedData.push(byteArray)}this.parsedData=Array.prototype.concat.apply([],this.parsedData),this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function QRCodeModel(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber,this.errorCorrectLevel=errorCorrectLevel,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}QR8bitByte.prototype={getLength:function(buffer){return this.parsedData.length},write:function(buffer){for(var i=0,l=this.parsedData.length;i<l;i++)buffer.put(this.parsedData[i],8)}},QRCodeModel.prototype={addData:function(data){var newData=new QR8bitByte(data);this.dataList.push(newData),this.dataCache=null},isDark:function(row,col){if(row<0||this.moduleCount<=row||col<0||this.moduleCount<=col)throw new Error(row+","+col);return this.modules[row][col]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(test,maskPattern){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++)this.modules[row][col]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(test,maskPattern),this.typeNumber>=7&&this.setupTypeNumber(test),null==this.dataCache&&(this.dataCache=QRCodeModel.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,maskPattern)},setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++)if(!(row+r<=-1||this.moduleCount<=row+r))for(var c=-1;c<=7;c++)col+c<=-1||this.moduleCount<=col+c||(this.modules[row+r][col+c]=0<=r&&r<=6&&(0==c||6==c)||0<=c&&c<=6&&(0==r||6==r)||2<=r&&r<=4&&2<=c&&c<=4)},getBestMaskPattern:function(){for(var minLostPoint=0,pattern=0,i=0;i<8;i++){this.makeImpl(!0,i);var lostPoint=QRUtil.getLostPoint(this);(0==i||minLostPoint>lostPoint)&&(minLostPoint=lostPoint,pattern=i)}return pattern},createMovieClip:function(target_mc,instance_name,depth){var qr_mc=target_mc.createEmptyMovieClip(instance_name,depth),cs=1;this.make();for(var row=0;row<this.modules.length;row++)for(var y=1*row,col=0;col<this.modules[row].length;col++){var x=1*col,dark;this.modules[row][col]&&(qr_mc.beginFill(0,100),qr_mc.moveTo(x,y),qr_mc.lineTo(x+1,y),qr_mc.lineTo(x+1,y+1),qr_mc.lineTo(x,y+1),qr_mc.endFill())}return qr_mc},setupTimingPattern:function(){for(var r=8;r<this.moduleCount-8;r++)null==this.modules[r][6]&&(this.modules[r][6]=r%2==0);for(var c=8;c<this.moduleCount-8;c++)null==this.modules[6][c]&&(this.modules[6][c]=c%2==0)},setupPositionAdjustPattern:function(){for(var pos=QRUtil.getPatternPosition(this.typeNumber),i=0;i<pos.length;i++)for(var j=0;j<pos.length;j++){var row=pos[i],col=pos[j];if(null==this.modules[row][col])for(var r=-2;r<=2;r++)for(var c=-2;c<=2;c++)this.modules[row+r][col+c]=-2==r||2==r||-2==c||2==c||0==r&&0==c}},setupTypeNumber:function(test){for(var bits=QRUtil.getBCHTypeNumber(this.typeNumber),i=0;i<18;i++){var mod=!test&&1==(bits>>i&1);this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=mod}for(var i=0;i<18;i++){var mod=!test&&1==(bits>>i&1);this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=mod}},setupTypeInfo:function(test,maskPattern){for(var data=this.errorCorrectLevel<<3|maskPattern,bits=QRUtil.getBCHTypeInfo(data),i=0;i<15;i++){var mod=!test&&1==(bits>>i&1);i<6?this.modules[i][8]=mod:i<8?this.modules[i+1][8]=mod:this.modules[this.moduleCount-15+i][8]=mod}for(var i=0;i<15;i++){var mod=!test&&1==(bits>>i&1);i<8?this.modules[8][this.moduleCount-i-1]=mod:i<9?this.modules[8][15-i-1+1]=mod:this.modules[8][15-i-1]=mod}this.modules[this.moduleCount-8][8]=!test},mapData:function(data,maskPattern){for(var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0,col=this.moduleCount-1;col>0;col-=2)for(6==col&&col--;;){for(var c=0;c<2;c++)if(null==this.modules[row][col-c]){var dark=!1,mask;byteIndex<data.length&&(dark=1==(data[byteIndex]>>>bitIndex&1)),QRUtil.getMask(maskPattern,row,col-c)&&(dark=!dark),this.modules[row][col-c]=dark,-1==--bitIndex&&(byteIndex++,bitIndex=7)}if((row+=inc)<0||this.moduleCount<=row){row-=inc,inc=-inc;break}}}},QRCodeModel.PAD0=236,QRCodeModel.PAD1=17,QRCodeModel.createData=function(typeNumber,errorCorrectLevel,dataList){for(var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel),buffer=new QRBitBuffer,i=0;i<dataList.length;i++){var data=dataList[i];buffer.put(data.mode,4),buffer.put(data.getLength(),QRUtil.getLengthInBits(data.mode,typeNumber)),data.write(buffer)}for(var totalDataCount=0,i=0;i<rsBlocks.length;i++)totalDataCount+=rsBlocks[i].dataCount;if(buffer.getLengthInBits()>8*totalDataCount)throw new Error("code length overflow. ("+buffer.getLengthInBits()+">"+8*totalDataCount+")");for(buffer.getLengthInBits()+4<=8*totalDataCount&&buffer.put(0,4);buffer.getLengthInBits()%8!=0;)buffer.putBit(!1);for(;!(buffer.getLengthInBits()>=8*totalDataCount||(buffer.put(QRCodeModel.PAD0,8),buffer.getLengthInBits()>=8*totalDataCount));)buffer.put(QRCodeModel.PAD1,8);return QRCodeModel.createBytes(buffer,rsBlocks)},QRCodeModel.createBytes=function(buffer,rsBlocks){for(var offset=0,maxDcCount=0,maxEcCount=0,dcdata=new Array(rsBlocks.length),ecdata=new Array(rsBlocks.length),r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount,ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount),maxEcCount=Math.max(maxEcCount,ecCount),dcdata[r]=new Array(dcCount);for(var i=0;i<dcdata[r].length;i++)dcdata[r][i]=255&buffer.buffer[i+offset];offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount),rawPoly,modPoly=new QRPolynomial(dcdata[r],rsPoly.getLength()-1).mod(rsPoly);ecdata[r]=new Array(rsPoly.getLength()-1);for(var i=0;i<ecdata[r].length;i++){var modIndex=i+modPoly.getLength()-ecdata[r].length;ecdata[r][i]=modIndex>=0?modPoly.get(modIndex):0}}for(var totalCodeCount=0,i=0;i<rsBlocks.length;i++)totalCodeCount+=rsBlocks[i].totalCount;for(var data=new Array(totalCodeCount),index=0,i=0;i<maxDcCount;i++)for(var r=0;r<rsBlocks.length;r++)i<dcdata[r].length&&(data[index++]=dcdata[r][i]);for(var i=0;i<maxEcCount;i++)for(var r=0;r<rsBlocks.length;r++)i<ecdata[r].length&&(data[index++]=ecdata[r][i]);return data};for(var QRMode={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},QRErrorCorrectLevel={L:1,M:0,Q:3,H:2},QRMaskPattern_PATTERN000=0,QRMaskPattern_PATTERN001=1,QRMaskPattern_PATTERN010=2,QRMaskPattern_PATTERN011=3,QRMaskPattern_PATTERN100=4,QRMaskPattern_PATTERN101=5,QRMaskPattern_PATTERN110=6,QRMaskPattern_PATTERN111=7,QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(data){for(var d=data<<10;QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0;)d^=QRUtil.G15<<QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15);return(data<<10|d)^QRUtil.G15_MASK},getBCHTypeNumber:function(data){for(var d=data<<12;QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0;)d^=QRUtil.G18<<QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18);return data<<12|d},getBCHDigit:function(data){for(var digit=0;0!=data;)digit++,data>>>=1;return digit},getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber-1]},getMask:function(maskPattern,i,j){switch(maskPattern){case QRMaskPattern_PATTERN000:return(i+j)%2==0;case QRMaskPattern_PATTERN001:return i%2==0;case QRMaskPattern_PATTERN010:return j%3==0;case QRMaskPattern_PATTERN011:return(i+j)%3==0;case QRMaskPattern_PATTERN100:return(Math.floor(i/2)+Math.floor(j/3))%2==0;case QRMaskPattern_PATTERN101:return i*j%2+i*j%3==0;case QRMaskPattern_PATTERN110:return(i*j%2+i*j%3)%2==0;case QRMaskPattern_PATTERN111:return(i*j%3+(i+j)%2)%2==0;default:throw new Error("bad maskPattern:"+maskPattern)}},getErrorCorrectPolynomial:function(errorCorrectLength){for(var a=new QRPolynomial([1],0),i=0;i<errorCorrectLength;i++)a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));return a},getLengthInBits:function(mode,type){if(1<=type&&type<10)switch(mode){case QRMode.MODE_NUMBER:return 10;case QRMode.MODE_ALPHA_NUM:return 9;case QRMode.MODE_8BIT_BYTE:case QRMode.MODE_KANJI:return 8;default:throw new Error("mode:"+mode)}else if(type<27)switch(mode){case QRMode.MODE_NUMBER:return 12;case QRMode.MODE_ALPHA_NUM:return 11;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 10;default:throw new Error("mode:"+mode)}else{if(!(type<41))throw new Error("type:"+type);switch(mode){case QRMode.MODE_NUMBER:return 14;case QRMode.MODE_ALPHA_NUM:return 13;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 12;default:throw new Error("mode:"+mode)}}},getLostPoint:function(qrCode){for(var moduleCount=qrCode.getModuleCount(),lostPoint=0,row=0;row<moduleCount;row++)for(var col=0;col<moduleCount;col++){for(var sameCount=0,dark=qrCode.isDark(row,col),r=-1;r<=1;r++)if(!(row+r<0||moduleCount<=row+r))for(var c=-1;c<=1;c++)col+c<0||moduleCount<=col+c||0==r&&0==c||dark==qrCode.isDark(row+r,col+c)&&sameCount++;sameCount>5&&(lostPoint+=3+sameCount-5)}for(var row=0;row<moduleCount-1;row++)for(var col=0;col<moduleCount-1;col++){var count=0;qrCode.isDark(row,col)&&count++,qrCode.isDark(row+1,col)&&count++,qrCode.isDark(row,col+1)&&count++,qrCode.isDark(row+1,col+1)&&count++,0!=count&&4!=count||(lostPoint+=3)}for(var row=0;row<moduleCount;row++)for(var col=0;col<moduleCount-6;col++)qrCode.isDark(row,col)&&!qrCode.isDark(row,col+1)&&qrCode.isDark(row,col+2)&&qrCode.isDark(row,col+3)&&qrCode.isDark(row,col+4)&&!qrCode.isDark(row,col+5)&&qrCode.isDark(row,col+6)&&(lostPoint+=40);for(var col=0;col<moduleCount;col++)for(var row=0;row<moduleCount-6;row++)qrCode.isDark(row,col)&&!qrCode.isDark(row+1,col)&&qrCode.isDark(row+2,col)&&qrCode.isDark(row+3,col)&&qrCode.isDark(row+4,col)&&!qrCode.isDark(row+5,col)&&qrCode.isDark(row+6,col)&&(lostPoint+=40);for(var darkCount=0,col=0;col<moduleCount;col++)for(var row=0;row<moduleCount;row++)qrCode.isDark(row,col)&&darkCount++;var ratio;return lostPoint+=10*(Math.abs(100*darkCount/moduleCount/moduleCount-50)/5)}},QRMath={glog:function(n){if(n<1)throw new Error("glog("+n+")");return QRMath.LOG_TABLE[n]},gexp:function(n){for(;n<0;)n+=255;for(;n>=256;)n-=255;return QRMath.EXP_TABLE[n]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)},i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;for(var i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];for(var i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;function QRPolynomial(num,shift){if(null==num.length)throw new Error(num.length+"/"+shift);for(var offset=0;offset<num.length&&0==num[offset];)offset++;this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset]}function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount,this.dataCount=dataCount}function QRBitBuffer(){this.buffer=[],this.length=0}QRPolynomial.prototype={get:function(index){return this.num[index]},getLength:function(){return this.num.length},multiply:function(e){for(var num=new Array(this.getLength()+e.getLength()-1),i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(num,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;for(var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0)),num=new Array(this.getLength()),i=0;i<this.getLength();i++)num[i]=this.get(i);for(var i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)}},QRRSBlock.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],QRRSBlock.getRSBlocks=function(typeNumber,errorCorrectLevel){var rsBlock=QRRSBlock.getRsBlockTable(typeNumber,errorCorrectLevel);if(null==rsBlock)throw new Error("bad rs block @ typeNumber:"+typeNumber+"/errorCorrectLevel:"+errorCorrectLevel);for(var length=rsBlock.length/3,list=[],i=0;i<length;i++)for(var count=rsBlock[3*i+0],totalCount=rsBlock[3*i+1],dataCount=rsBlock[3*i+2],j=0;j<count;j++)list.push(new QRRSBlock(totalCount,dataCount));return list},QRRSBlock.getRsBlockTable=function(typeNumber,errorCorrectLevel){switch(errorCorrectLevel){case QRErrorCorrectLevel.L:return QRRSBlock.RS_BLOCK_TABLE[4*(typeNumber-1)+0];case QRErrorCorrectLevel.M:return QRRSBlock.RS_BLOCK_TABLE[4*(typeNumber-1)+1];case QRErrorCorrectLevel.Q:return QRRSBlock.RS_BLOCK_TABLE[4*(typeNumber-1)+2];case QRErrorCorrectLevel.H:return QRRSBlock.RS_BLOCK_TABLE[4*(typeNumber-1)+3];default:return}},QRBitBuffer.prototype={get:function(index){var bufIndex=Math.floor(index/8);return 1==(this.buffer[bufIndex]>>>7-index%8&1)},put:function(num,length){for(var i=0;i<length;i++)this.putBit(1==(num>>>length-i-1&1))},getLengthInBits:function(){return this.length},putBit:function(bit){var bufIndex=Math.floor(this.length/8);this.buffer.length<=bufIndex&&this.buffer.push(0),bit&&(this.buffer[bufIndex]|=128>>>this.length%8),this.length++}};var QRCodeLimitLength=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]];function _isSupportCanvas(){return"undefined"!=typeof CanvasRenderingContext2D}function _getAndroid(){var android=!1,sAgent=navigator.userAgent;if(/android/i.test(sAgent)){android=!0;var aMat=sAgent.toString().match(/android ([0-9]\.[0-9])/i);aMat&&aMat[1]&&(android=parseFloat(aMat[1]))}return android}var svgDrawer=function(){var Drawing=function(el,htOption){this._el=el,this._htOption=htOption};return Drawing.prototype.draw=function(oQRCode){var _htOption=this._htOption,_el=this._el,nCount=oQRCode.getModuleCount(),nWidth=Math.floor(_htOption.width/nCount),nHeight=Math.floor(_htOption.height/nCount);function makeSVG(tag,attrs){var el=document.createElementNS("http://www.w3.org/2000/svg",tag);for(var k in attrs)attrs.hasOwnProperty(k)&&el.setAttribute(k,attrs[k]);return el}this.clear();var svg=makeSVG("svg",{viewBox:"0 0 "+String(nCount)+" "+String(nCount),width:"100%",height:"100%",fill:_htOption.colorLight});svg.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),_el.appendChild(svg),svg.appendChild(makeSVG("rect",{fill:_htOption.colorLight,width:"100%",height:"100%"})),svg.appendChild(makeSVG("rect",{fill:_htOption.colorDark,width:"1",height:"1",id:"template"}));for(var row=0;row<nCount;row++)for(var col=0;col<nCount;col++)if(oQRCode.isDark(row,col)){var child=makeSVG("use",{x:String(col),y:String(row)});child.setAttributeNS("http://www.w3.org/1999/xlink","href","#template"),svg.appendChild(child)}},Drawing.prototype.clear=function(){for(;this._el.hasChildNodes();)this._el.removeChild(this._el.lastChild)},Drawing}(),useSVG,Drawing="svg"===document.documentElement.tagName.toLowerCase()?svgDrawer:_isSupportCanvas()?function(){function _onMakeImage(){this._elImage.src=this._elCanvas.toDataURL("image/png"),this._elImage.style.display="block",this._elCanvas.style.display="none"}if(this._android&&this._android<=2.1){var factor=1/window.devicePixelRatio,drawImage=CanvasRenderingContext2D.prototype.drawImage;CanvasRenderingContext2D.prototype.drawImage=function(image,sx,sy,sw,sh,dx,dy,dw,dh){if("nodeName"in image&&/img/i.test(image.nodeName))for(var i=arguments.length-1;i>=1;i--)arguments[i]=arguments[i]*factor;else void 0===dw&&(arguments[1]*=factor,arguments[2]*=factor,arguments[3]*=factor,arguments[4]*=factor);drawImage.apply(this,arguments)}}function _safeSetDataURI(fSuccess,fFail){var self=this;if(self._fFail=fFail,self._fSuccess=fSuccess,null===self._bSupportDataURI){var el=document.createElement("img"),fOnError=function(){self._bSupportDataURI=!1,self._fFail&&self._fFail.call(self)},fOnSuccess=function(){self._bSupportDataURI=!0,self._fSuccess&&self._fSuccess.call(self)};return el.onabort=fOnError,el.onerror=fOnError,el.onload=fOnSuccess,void(el.src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==")}!0===self._bSupportDataURI&&self._fSuccess?self._fSuccess.call(self):!1===self._bSupportDataURI&&self._fFail&&self._fFail.call(self)}var Drawing=function(el,htOption){this._bIsPainted=!1,this._android=_getAndroid(),this._htOption=htOption,this._elCanvas=document.createElement("canvas"),this._elCanvas.width=htOption.width,this._elCanvas.height=htOption.height,el.appendChild(this._elCanvas),this._el=el,this._oContext=this._elCanvas.getContext("2d"),this._bIsPainted=!1,this._elImage=document.createElement("img"),this._elImage.alt="Scan me!",this._elImage.style.display="none",this._el.appendChild(this._elImage),this._bSupportDataURI=null};return Drawing.prototype.draw=function(oQRCode){var _elImage=this._elImage,_oContext=this._oContext,_htOption=this._htOption,nCount=oQRCode.getModuleCount(),nWidth=_htOption.width/nCount,nHeight=_htOption.height/nCount,nRoundedWidth=Math.round(nWidth),nRoundedHeight=Math.round(nHeight);_elImage.style.display="none",this.clear();for(var row=0;row<nCount;row++)for(var col=0;col<nCount;col++){var bIsDark=oQRCode.isDark(row,col),nLeft=col*nWidth,nTop=row*nHeight;_oContext.strokeStyle=bIsDark?_htOption.colorDark:_htOption.colorLight,_oContext.lineWidth=1,_oContext.fillStyle=bIsDark?_htOption.colorDark:_htOption.colorLight,_oContext.fillRect(nLeft,nTop,nWidth,nHeight),_oContext.strokeRect(Math.floor(nLeft)+.5,Math.floor(nTop)+.5,nRoundedWidth,nRoundedHeight),_oContext.strokeRect(Math.ceil(nLeft)-.5,Math.ceil(nTop)-.5,nRoundedWidth,nRoundedHeight)}this._bIsPainted=!0},Drawing.prototype.makeImage=function(){this._bIsPainted&&_safeSetDataURI.call(this,_onMakeImage)},Drawing.prototype.isPainted=function(){return this._bIsPainted},Drawing.prototype.clear=function(){this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height),this._bIsPainted=!1},Drawing.prototype.round=function(nNumber){return nNumber?Math.floor(1e3*nNumber)/1e3:nNumber},Drawing}():function(){var Drawing=function(el,htOption){this._el=el,this._htOption=htOption};return Drawing.prototype.draw=function(oQRCode){for(var _htOption=this._htOption,_el=this._el,nCount=oQRCode.getModuleCount(),nWidth=Math.floor(_htOption.width/nCount),nHeight=Math.floor(_htOption.height/nCount),aHTML=['<table style="border:0;border-collapse:collapse;">'],row=0;row<nCount;row++){aHTML.push("<tr>");for(var col=0;col<nCount;col++)aHTML.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:'+nWidth+"px;height:"+nHeight+"px;background-color:"+(oQRCode.isDark(row,col)?_htOption.colorDark:_htOption.colorLight)+';"></td>');aHTML.push("</tr>")}aHTML.push("</table>"),_el.innerHTML=aHTML.join("");var elTable=_el.childNodes[0],nLeftMarginTable=(_htOption.width-elTable.offsetWidth)/2,nTopMarginTable=(_htOption.height-elTable.offsetHeight)/2;nLeftMarginTable>0&&nTopMarginTable>0&&(elTable.style.margin=nTopMarginTable+"px "+nLeftMarginTable+"px")},Drawing.prototype.clear=function(){this._el.innerHTML=""},Drawing}();function _getTypeNumber(sText,nCorrectLevel){for(var nType=1,length=_getUTF8Length(sText),i=0,len=QRCodeLimitLength.length;i<=len;i++){var nLimit=0;switch(nCorrectLevel){case QRErrorCorrectLevel.L:nLimit=QRCodeLimitLength[i][0];break;case QRErrorCorrectLevel.M:nLimit=QRCodeLimitLength[i][1];break;case QRErrorCorrectLevel.Q:nLimit=QRCodeLimitLength[i][2];break;case QRErrorCorrectLevel.H:nLimit=QRCodeLimitLength[i][3]}if(length<=nLimit)break;nType++}if(nType>QRCodeLimitLength.length)throw new Error("Too long data");return nType}function _getUTF8Length(sText){var replacedText=encodeURI(sText).toString().replace(/\%[0-9a-fA-F]{2}/g,"a");return replacedText.length+(replacedText.length!=sText?3:0)}(QRCode=function(el,vOption){if(this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRErrorCorrectLevel.H},"string"==typeof vOption&&(vOption={text:vOption}),vOption)for(var i in vOption)this._htOption[i]=vOption[i];"string"==typeof el&&(el=document.getElementById(el)),this._htOption.useSVG&&(Drawing=svgDrawer),this._android=_getAndroid(),this._el=el,this._oQRCode=null,this._oDrawing=new Drawing(this._el,this._htOption),this._htOption.text&&this.makeCode(this._htOption.text)}).prototype.makeCode=function(sText){this._oQRCode=new QRCodeModel(_getTypeNumber(sText,this._htOption.correctLevel),this._htOption.correctLevel),this._oQRCode.addData(sText),this._oQRCode.make(),this._el.title=sText,this._oDrawing.draw(this._oQRCode),this.makeImage()},QRCode.prototype.makeImage=function(){"function"==typeof this._oDrawing.makeImage&&(!this._android||this._android>=3)&&this._oDrawing.makeImage()},QRCode.prototype.clear=function(){this._oDrawing.clear()},QRCode.CorrectLevel=QRErrorCorrectLevel}(),function(root,factory){"function"==typeof define&&define.amd?define(factory):"object"==typeof exports&&"string"!=typeof exports.nodeName?module.exports=factory():root.Croppie=factory()}("undefined"!=typeof self?self:this,(function(){"function"!=typeof Promise&&function(a){function b(a,b){return function(){a.apply(b,arguments)}}function c(a){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],i(a,b(e,this),b(f,this))}function d(a){var b=this;return null===this._state?void this._deferreds.push(a):void k((function(){var c=b._state?a.onFulfilled:a.onRejected;if(null!==c){var d;try{d=c(b._value)}catch(e){return void a.reject(e)}a.resolve(d)}else(b._state?a.resolve:a.reject)(b._value)}))}function e(a){try{if(a===this)throw new TypeError("A promise cannot be resolved with itself.");if(a&&("object"==typeof a||"function"==typeof a)){var c=a.then;if("function"==typeof c)return void i(b(c,a),b(e,this),b(f,this))}this._state=!0,this._value=a,g.call(this)}catch(d){f.call(this,d)}}function f(a){this._state=!1,this._value=a,g.call(this)}function g(){for(var a=0,b=this._deferreds.length;b>a;a++)d.call(this,this._deferreds[a]);this._deferreds=null}function h(a,b,c,d){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.resolve=c,this.reject=d}function i(a,b,c){var d=!1;try{a((function(a){d||(d=!0,b(a))}),(function(a){d||(d=!0,c(a))}))}catch(e){if(d)return;d=!0,c(e)}}var j=setTimeout,k="function"==typeof setImmediate&&setImmediate||function(a){j(a,1)},l=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};c.prototype.catch=function(a){return this.then(null,a)},c.prototype.then=function(a,b){var e=this;return new c((function(c,f){d.call(e,new h(a,b,c,f))}))},c.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&l(arguments[0])?arguments[0]:arguments);return new c((function(b,c){function d(f,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,(function(a){d(f,a)}),c)}a[f]=g,0==--e&&b(a)}catch(i){c(i)}}if(0===a.length)return b([]);for(var e=a.length,f=0;f<a.length;f++)d(f,a[f])}))},c.resolve=function(a){return a&&"object"==typeof a&&a.constructor===c?a:new c((function(b){b(a)}))},c.reject=function(a){return new c((function(b,c){c(a)}))},c.race=function(a){return new c((function(b,c){for(var d=0,e=a.length;e>d;d++)a[d].then(b,c)}))},c._setImmediateFn=function(a){k=a},"undefined"!=typeof module&&module.exports?module.exports=c:a.Promise||(a.Promise=c)}(this),"undefined"!=typeof window&&"function"!=typeof window.CustomEvent&&function(){function CustomEvent(event,params){params=params||{bubbles:!1,cancelable:!1,detail:void 0};var evt=document.createEvent("CustomEvent");return evt.initCustomEvent(event,params.bubbles,params.cancelable,params.detail),evt}CustomEvent.prototype=window.Event.prototype,window.CustomEvent=CustomEvent}(),"undefined"==typeof HTMLCanvasElement||HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(callback,type,quality){for(var binStr=atob(this.toDataURL(type,quality).split(",")[1]),len=binStr.length,arr=new Uint8Array(len),i=0;i<len;i++)arr[i]=binStr.charCodeAt(i);callback(new Blob([arr],{type:type||"image/png"}))}});var cssPrefixes=["Webkit","Moz","ms"],emptyStyles="undefined"!=typeof document?document.createElement("div").style:{},EXIF_NORM=[1,8,3,6],EXIF_FLIP=[2,7,4,5],CSS_TRANS_ORG,CSS_TRANSFORM,CSS_USERSELECT;function vendorPrefix(prop){if(prop in emptyStyles)return prop;for(var capProp=prop[0].toUpperCase()+prop.slice(1),i=cssPrefixes.length;i--;)if((prop=cssPrefixes[i]+capProp)in emptyStyles)return prop}function getExifOffset(ornt,rotate){var arr=EXIF_NORM.indexOf(ornt)>-1?EXIF_NORM:EXIF_FLIP,index=arr.indexOf(ornt),offset=rotate/90%arr.length;return arr[(arr.length+index+offset%arr.length)%arr.length]}function deepExtend(destination,source){for(var property in destination=destination||{},source)source[property]&&source[property].constructor&&source[property].constructor===Object?(destination[property]=destination[property]||{},deepExtend(destination[property],source[property])):destination[property]=source[property];return destination}function clone(object){return deepExtend({},object)}function debounce(func,wait,immediate){var timeout;return function(){var context=this,args=arguments,later=function(){timeout=null,immediate||func.apply(context,args)},callNow=immediate&&!timeout;clearTimeout(timeout),timeout=setTimeout(later,wait),callNow&&func.apply(context,args)}}function dispatchChange(element){if("createEvent"in document){var evt=document.createEvent("HTMLEvents");evt.initEvent("change",!1,!0),element.dispatchEvent(evt)}else element.fireEvent("onchange")}function css(el,styles,val){if("string"==typeof styles){var tmp=styles;(styles={})[tmp]=val}for(var prop in styles)el.style[prop]=styles[prop]}function addClass(el,c){el.classList?el.classList.add(c):el.className+=" "+c}function removeClass(el,c){el.classList?el.classList.remove(c):el.className=el.className.replace(c,"")}function setAttributes(el,attrs){for(var key in attrs)el.setAttribute(key,attrs[key])}function num(v){return parseInt(v,10)}function loadImage(src,doExif){if(!src)throw"Source image missing";var img=new Image;return img.style.opacity="0",new Promise((function(resolve,reject){function _resolve(){img.style.opacity="1",setTimeout((function(){resolve(img)}),1)}img.removeAttribute("crossOrigin"),src.match(/^https?:\/\/|^\/\//)&&img.setAttribute("crossOrigin","anonymous"),img.onload=function(){doExif?EXIF.getData(img,(function(){_resolve()})):_resolve()},img.onerror=function(ev){img.style.opacity=1,setTimeout((function(){reject(ev)}),1)},img.src=src}))}function naturalImageDimensions(img,ornt){var w=img.naturalWidth,h=img.naturalHeight,orient=ornt||getExifOrientation(img);if(orient&&orient>=5){var x=w;w=h,h=x}return{width:w,height:h}}CSS_TRANSFORM=vendorPrefix("transform"),CSS_TRANS_ORG=vendorPrefix("transformOrigin"),CSS_USERSELECT=vendorPrefix("userSelect");var TRANSLATE_OPTS={translate3d:{suffix:", 0px"},translate:{suffix:""}},Transform=function(x,y,scale){this.x=parseFloat(x),this.y=parseFloat(y),this.scale=parseFloat(scale)};Transform.parse=function(v){return v.style?Transform.parse(v.style[CSS_TRANSFORM]):v.indexOf("matrix")>-1||v.indexOf("none")>-1?Transform.fromMatrix(v):Transform.fromString(v)},Transform.fromMatrix=function(v){var vals=v.substring(7).split(",");return vals.length&&"none"!==v||(vals=[1,0,0,1,0,0]),new Transform(num(vals[4]),num(vals[5]),parseFloat(vals[0]))},Transform.fromString=function(v){var values=v.split(") "),translate=values[0].substring(Croppie.globals.translate.length+1).split(","),scale=values.length>1?values[1].substring(6):1,x=translate.length>1?translate[0]:0,y=translate.length>1?translate[1]:0;return new Transform(x,y,scale)},Transform.prototype.toString=function(){var suffix=TRANSLATE_OPTS[Croppie.globals.translate].suffix||"";return Croppie.globals.translate+"("+this.x+"px, "+this.y+"px"+suffix+") scale("+this.scale+")"};var TransformOrigin=function(el){if(!el||!el.style[CSS_TRANS_ORG])return this.x=0,void(this.y=0);var css=el.style[CSS_TRANS_ORG].split(" ");this.x=parseFloat(css[0]),this.y=parseFloat(css[1])};function getExifOrientation(img){return img.exifdata&&img.exifdata.Orientation?num(img.exifdata.Orientation):1}function drawCanvas(canvas,img,orientation){var width=img.width,height=img.height,ctx=canvas.getContext("2d");switch(canvas.width=img.width,canvas.height=img.height,ctx.save(),orientation){case 2:ctx.translate(width,0),ctx.scale(-1,1);break;case 3:ctx.translate(width,height),ctx.rotate(180*Math.PI/180);break;case 4:ctx.translate(0,height),ctx.scale(1,-1);break;case 5:canvas.width=height,canvas.height=width,ctx.rotate(90*Math.PI/180),ctx.scale(1,-1);break;case 6:canvas.width=height,canvas.height=width,ctx.rotate(90*Math.PI/180),ctx.translate(0,-height);break;case 7:canvas.width=height,canvas.height=width,ctx.rotate(-90*Math.PI/180),ctx.translate(-width,height),ctx.scale(1,-1);break;case 8:canvas.width=height,canvas.height=width,ctx.translate(0,width),ctx.rotate(-90*Math.PI/180)}ctx.drawImage(img,0,0,width,height),ctx.restore()}function _create(){var self=this,contClass="croppie-container",customViewportClass=this.options.viewport.type?"cr-vp-"+this.options.viewport.type:null,boundary,img,viewport,overlay,bw,bh;this.options.useCanvas=this.options.enableOrientation||_hasExif.call(this),this.data={},this.elements={},boundary=this.elements.boundary=document.createElement("div"),viewport=this.elements.viewport=document.createElement("div"),img=this.elements.img=document.createElement("img"),overlay=this.elements.overlay=document.createElement("div"),this.options.useCanvas?(this.elements.canvas=document.createElement("canvas"),this.elements.preview=this.elements.canvas):this.elements.preview=img,addClass(boundary,"cr-boundary"),boundary.setAttribute("aria-dropeffect","none"),bw=this.options.boundary.width,bh=this.options.boundary.height,css(boundary,{width:bw+(isNaN(bw)?"":"px"),height:bh+(isNaN(bh)?"":"px")}),addClass(viewport,"cr-viewport"),customViewportClass&&addClass(viewport,customViewportClass),css(viewport,{width:this.options.viewport.width+"px",height:this.options.viewport.height+"px"}),viewport.setAttribute("tabindex",0),addClass(this.elements.preview,"cr-image"),setAttributes(this.elements.preview,{alt:"preview","aria-grabbed":"false"}),addClass(overlay,"cr-overlay"),this.element.appendChild(boundary),boundary.appendChild(this.elements.preview),boundary.appendChild(viewport),boundary.appendChild(overlay),addClass(this.element,contClass),this.options.customClass&&addClass(this.element,this.options.customClass),_initDraggable.call(this),this.options.enableZoom&&_initializeZoom.call(this),this.options.enableResize&&_initializeResize.call(this)}function _hasExif(){return this.options.enableExif&&window.EXIF}function _initializeResize(){var self=this,wrap=document.createElement("div"),isDragging=!1,direction,originalX,originalY,minSize=50,maxWidth,maxHeight,vr,hr;function mouseDown(ev){if((void 0===ev.button||0===ev.button)&&(ev.preventDefault(),!isDragging)){var overlayRect=self.elements.overlay.getBoundingClientRect();if(isDragging=!0,originalX=ev.pageX,originalY=ev.pageY,direction=-1!==ev.currentTarget.className.indexOf("vertical")?"v":"h",maxWidth=overlayRect.width,maxHeight=overlayRect.height,ev.touches){var touches=ev.touches[0];originalX=touches.pageX,originalY=touches.pageY}window.addEventListener("mousemove",mouseMove),window.addEventListener("touchmove",mouseMove),window.addEventListener("mouseup",mouseUp),window.addEventListener("touchend",mouseUp),document.body.style[CSS_USERSELECT]="none"}}function mouseMove(ev){var pageX=ev.pageX,pageY=ev.pageY;if(ev.preventDefault(),ev.touches){var touches=ev.touches[0];pageX=touches.pageX,pageY=touches.pageY}var deltaX=pageX-originalX,deltaY=pageY-originalY,newHeight=self.options.viewport.height+deltaY,newWidth=self.options.viewport.width+deltaX;"v"===direction&&newHeight>=50&&newHeight<=maxHeight?(css(wrap,{height:newHeight+"px"}),self.options.boundary.height+=deltaY,css(self.elements.boundary,{height:self.options.boundary.height+"px"}),self.options.viewport.height+=deltaY,css(self.elements.viewport,{height:self.options.viewport.height+"px"})):"h"===direction&&newWidth>=50&&newWidth<=maxWidth&&(css(wrap,{width:newWidth+"px"}),self.options.boundary.width+=deltaX,css(self.elements.boundary,{width:self.options.boundary.width+"px"}),self.options.viewport.width+=deltaX,css(self.elements.viewport,{width:self.options.viewport.width+"px"})),_updateOverlay.call(self),_updateZoomLimits.call(self),_updateCenterPoint.call(self),_triggerUpdate.call(self),originalY=pageY,originalX=pageX}function mouseUp(){isDragging=!1,window.removeEventListener("mousemove",mouseMove),window.removeEventListener("touchmove",mouseMove),window.removeEventListener("mouseup",mouseUp),window.removeEventListener("touchend",mouseUp),document.body.style[CSS_USERSELECT]=""}addClass(wrap,"cr-resizer"),css(wrap,{width:this.options.viewport.width+"px",height:this.options.viewport.height+"px"}),this.options.resizeControls.height&&(addClass(vr=document.createElement("div"),"cr-resizer-vertical"),wrap.appendChild(vr)),this.options.resizeControls.width&&(addClass(hr=document.createElement("div"),"cr-resizer-horisontal"),wrap.appendChild(hr)),vr&&(vr.addEventListener("mousedown",mouseDown),vr.addEventListener("touchstart",mouseDown)),hr&&(hr.addEventListener("mousedown",mouseDown),hr.addEventListener("touchstart",mouseDown)),this.elements.boundary.appendChild(wrap)}function _setZoomerVal(v){if(this.options.enableZoom){var z=this.elements.zoomer,val=fix(v,4);z.value=Math.max(parseFloat(z.min),Math.min(parseFloat(z.max),val)).toString()}}function _initializeZoom(){var self=this,wrap=self.elements.zoomerWrap=document.createElement("div"),zoomer=self.elements.zoomer=document.createElement("input");function change(){_onZoom.call(self,{value:parseFloat(zoomer.value),origin:new TransformOrigin(self.elements.preview),viewportRect:self.elements.viewport.getBoundingClientRect(),transform:Transform.parse(self.elements.preview)})}function scroll(ev){var delta,targetZoom;if("ctrl"===self.options.mouseWheelZoom&&!0!==ev.ctrlKey)return 0;delta=ev.wheelDelta?ev.wheelDelta/1200:ev.deltaY?ev.deltaY/1060:ev.detail?ev.detail/-60:0,targetZoom=self._currentZoom+delta*self._currentZoom,ev.preventDefault(),_setZoomerVal.call(self,targetZoom),change.call(self)}addClass(wrap,"cr-slider-wrap"),addClass(zoomer,"cr-slider"),zoomer.type="range",zoomer.step="0.0001",zoomer.value="1",zoomer.style.display=self.options.showZoomer?"":"none",zoomer.setAttribute("aria-label","zoom"),self.element.appendChild(wrap),wrap.appendChild(zoomer),self._currentZoom=1,self.elements.zoomer.addEventListener("input",change),self.elements.zoomer.addEventListener("change",change),self.options.mouseWheelZoom&&(self.elements.boundary.addEventListener("mousewheel",scroll),self.elements.boundary.addEventListener("DOMMouseScroll",scroll))}function _onZoom(ui){var self=this,transform=ui?ui.transform:Transform.parse(self.elements.preview),vpRect=ui?ui.viewportRect:self.elements.viewport.getBoundingClientRect(),origin=ui?ui.origin:new TransformOrigin(self.elements.preview);function applyCss(){var transCss={};transCss[CSS_TRANSFORM]=transform.toString(),transCss[CSS_TRANS_ORG]=origin.toString(),css(self.elements.preview,transCss)}if(self._currentZoom=ui?ui.value:self._currentZoom,transform.scale=self._currentZoom,self.elements.zoomer.setAttribute("aria-valuenow",self._currentZoom),applyCss(),self.options.enforceBoundary){var boundaries=_getVirtualBoundaries.call(self,vpRect),transBoundaries=boundaries.translate,oBoundaries=boundaries.origin;transform.x>=transBoundaries.maxX&&(origin.x=oBoundaries.minX,transform.x=transBoundaries.maxX),transform.x<=transBoundaries.minX&&(origin.x=oBoundaries.maxX,transform.x=transBoundaries.minX),transform.y>=transBoundaries.maxY&&(origin.y=oBoundaries.minY,transform.y=transBoundaries.maxY),transform.y<=transBoundaries.minY&&(origin.y=oBoundaries.maxY,transform.y=transBoundaries.minY)}applyCss(),_debouncedOverlay.call(self),_triggerUpdate.call(self)}function _getVirtualBoundaries(viewport){var self=this,scale=this._currentZoom,vpWidth=viewport.width,vpHeight=viewport.height,centerFromBoundaryX=this.elements.boundary.clientWidth/2,centerFromBoundaryY=this.elements.boundary.clientHeight/2,imgRect=this.elements.preview.getBoundingClientRect(),curImgWidth=imgRect.width,curImgHeight=imgRect.height,halfWidth=vpWidth/2,halfHeight=vpHeight/2,maxX=-1*(halfWidth/scale-centerFromBoundaryX),minX,maxY=-1*(halfHeight/scale-centerFromBoundaryY),minY,originMinX=1/scale*halfWidth,originMaxX,originMinY=1/scale*halfHeight,originMaxY;return{translate:{maxX:maxX,minX:maxX-(curImgWidth*(1/scale)-vpWidth*(1/scale)),maxY:maxY,minY:maxY-(curImgHeight*(1/scale)-vpHeight*(1/scale))},origin:{maxX:curImgWidth*(1/scale)-originMinX,minX:originMinX,maxY:curImgHeight*(1/scale)-originMinY,minY:originMinY}}}function _updateCenterPoint(rotate){var self=this,scale=this._currentZoom,data=this.elements.preview.getBoundingClientRect(),vpData=this.elements.viewport.getBoundingClientRect(),transform=Transform.parse(this.elements.preview.style[CSS_TRANSFORM]),pc=new TransformOrigin(this.elements.preview),top=vpData.top-data.top+vpData.height/2,left=vpData.left-data.left+vpData.width/2,center={},adj={};if(rotate){var cx=pc.x,cy=pc.y,tx=transform.x,ty=transform.y;center.y=cx,center.x=cy,transform.y=tx,transform.x=ty}else center.y=top/scale,center.x=left/scale,adj.y=(center.y-pc.y)*(1-scale),adj.x=(center.x-pc.x)*(1-scale),transform.x-=adj.x,transform.y-=adj.y;var newCss={};newCss[CSS_TRANS_ORG]=center.x+"px "+center.y+"px",newCss[CSS_TRANSFORM]=transform.toString(),css(this.elements.preview,newCss)}function _initDraggable(){var self=this,isDragging=!1,originalX,originalY,originalDistance,vpRect,transform;function assignTransformCoordinates(deltaX,deltaY){var imgRect=self.elements.preview.getBoundingClientRect(),top=transform.y+deltaY,left=transform.x+deltaX;self.options.enforceBoundary?(vpRect.top>imgRect.top+deltaY&&vpRect.bottom<imgRect.bottom+deltaY&&(transform.y=top),vpRect.left>imgRect.left+deltaX&&vpRect.right<imgRect.right+deltaX&&(transform.x=left)):(transform.y=top,transform.x=left)}function toggleGrabState(isDragging){self.elements.preview.setAttribute("aria-grabbed",isDragging),self.elements.boundary.setAttribute("aria-dropeffect",isDragging?"move":"none")}function keyDown(ev){var LEFT_ARROW=37,UP_ARROW=38,RIGHT_ARROW=39,DOWN_ARROW=40,zoom;if(!ev.shiftKey||38!==ev.keyCode&&40!==ev.keyCode){if(self.options.enableKeyMovement&&ev.keyCode>=37&&ev.keyCode<=40){ev.preventDefault();var movement=parseKeyDown(ev.keyCode);transform=Transform.parse(self.elements.preview),document.body.style[CSS_USERSELECT]="none",vpRect=self.elements.viewport.getBoundingClientRect(),keyMove(movement)}}else zoom=38===ev.keyCode?parseFloat(self.elements.zoomer.value)+parseFloat(self.elements.zoomer.step):parseFloat(self.elements.zoomer.value)-parseFloat(self.elements.zoomer.step),self.setZoom(zoom);function parseKeyDown(key){switch(key){case 37:return[1,0];case 38:return[0,1];case 39:return[-1,0];case 40:return[0,-1]}}}function keyMove(movement){var deltaX,deltaY,newCss={};assignTransformCoordinates(movement[0],movement[1]),newCss[CSS_TRANSFORM]=transform.toString(),css(self.elements.preview,newCss),_updateOverlay.call(self),document.body.style[CSS_USERSELECT]="",_updateCenterPoint.call(self),_triggerUpdate.call(self),originalDistance=0}function mouseDown(ev){if((void 0===ev.button||0===ev.button)&&(ev.preventDefault(),!isDragging)){if(isDragging=!0,originalX=ev.pageX,originalY=ev.pageY,ev.touches){var touches=ev.touches[0];originalX=touches.pageX,originalY=touches.pageY}toggleGrabState(isDragging),transform=Transform.parse(self.elements.preview),window.addEventListener("mousemove",mouseMove),window.addEventListener("touchmove",mouseMove),window.addEventListener("mouseup",mouseUp),window.addEventListener("touchend",mouseUp),document.body.style[CSS_USERSELECT]="none",vpRect=self.elements.viewport.getBoundingClientRect()}}function mouseMove(ev){ev.preventDefault();var pageX=ev.pageX,pageY=ev.pageY;if(ev.touches){var touches=ev.touches[0];pageX=touches.pageX,pageY=touches.pageY}var deltaX=pageX-originalX,deltaY=pageY-originalY,newCss={};if("touchmove"===ev.type&&ev.touches.length>1){var touch1=ev.touches[0],touch2=ev.touches[1],dist=Math.sqrt((touch1.pageX-touch2.pageX)*(touch1.pageX-touch2.pageX)+(touch1.pageY-touch2.pageY)*(touch1.pageY-touch2.pageY));originalDistance||(originalDistance=dist/self._currentZoom);var scale=dist/originalDistance;return _setZoomerVal.call(self,scale),void dispatchChange(self.elements.zoomer)}assignTransformCoordinates(deltaX,deltaY),newCss[CSS_TRANSFORM]=transform.toString(),css(self.elements.preview,newCss),_updateOverlay.call(self),originalY=pageY,originalX=pageX}function mouseUp(){toggleGrabState(isDragging=!1),window.removeEventListener("mousemove",mouseMove),window.removeEventListener("touchmove",mouseMove),window.removeEventListener("mouseup",mouseUp),window.removeEventListener("touchend",mouseUp),document.body.style[CSS_USERSELECT]="",_updateCenterPoint.call(self),_triggerUpdate.call(self),originalDistance=0}self.elements.overlay.addEventListener("mousedown",mouseDown),self.elements.viewport.addEventListener("keydown",keyDown),self.elements.overlay.addEventListener("touchstart",mouseDown)}function _updateOverlay(){if(this.elements){var self=this,boundRect=this.elements.boundary.getBoundingClientRect(),imgData=this.elements.preview.getBoundingClientRect();css(this.elements.overlay,{width:imgData.width+"px",height:imgData.height+"px",top:imgData.top-boundRect.top+"px",left:imgData.left-boundRect.left+"px"})}}TransformOrigin.prototype.toString=function(){return this.x+"px "+this.y+"px"};var _debouncedOverlay=debounce(_updateOverlay,500);function _triggerUpdate(){var self=this,data=this.get(),ev;_isVisible.call(this)&&(this.options.update.call(this,data),this.$&&"undefined"==typeof Prototype?this.$(this.element).trigger("update.croppie",data):(window.CustomEvent?ev=new CustomEvent("update",{detail:data}):(ev=document.createEvent("CustomEvent")).initCustomEvent("update",!0,!0,data),this.element.dispatchEvent(ev)))}function _isVisible(){return this.elements.preview.offsetHeight>0&&this.elements.preview.offsetWidth>0}function _updatePropertiesFromImage(){var self=this,initialZoom=1,cssReset={},img=this.elements.preview,imgData,transformReset=new Transform(0,0,1),originReset=new TransformOrigin,isVisible;_isVisible.call(this)&&!this.data.bound&&(this.data.bound=!0,cssReset[CSS_TRANSFORM]=transformReset.toString(),cssReset[CSS_TRANS_ORG]=originReset.toString(),cssReset.opacity=1,css(img,cssReset),imgData=this.elements.preview.getBoundingClientRect(),this._originalImageWidth=imgData.width,this._originalImageHeight=imgData.height,this.data.orientation=_hasExif.call(this)?getExifOrientation(this.elements.img):this.data.orientation,this.options.enableZoom?_updateZoomLimits.call(this,!0):this._currentZoom=1,transformReset.scale=this._currentZoom,cssReset[CSS_TRANSFORM]=transformReset.toString(),css(img,cssReset),this.data.points.length?_bindPoints.call(this,this.data.points):_centerImage.call(this),_updateCenterPoint.call(this),_updateOverlay.call(this))}function _updateZoomLimits(initial){var self=this,minZoom=Math.max(this.options.minZoom,0)||0,maxZoom=this.options.maxZoom||1.5,initialZoom,defaultInitialZoom,zoomer=this.elements.zoomer,scale=parseFloat(zoomer.value),boundaryData=this.elements.boundary.getBoundingClientRect(),imgData=naturalImageDimensions(this.elements.img,this.data.orientation),vpData=this.elements.viewport.getBoundingClientRect(),minW,minH;this.options.enforceBoundary&&(minW=vpData.width/imgData.width,minH=vpData.height/imgData.height,minZoom=Math.max(minW,minH)),minZoom>=maxZoom&&(maxZoom=minZoom+1),zoomer.min=fix(minZoom,4),zoomer.max=fix(maxZoom,4),!initial&&(scale<zoomer.min||scale>zoomer.max)?_setZoomerVal.call(this,scale<zoomer.min?zoomer.min:zoomer.max):initial&&(defaultInitialZoom=Math.max(boundaryData.width/imgData.width,boundaryData.height/imgData.height),initialZoom=null!==this.data.boundZoom?this.data.boundZoom:defaultInitialZoom,_setZoomerVal.call(this,initialZoom)),dispatchChange(zoomer)}function _bindPoints(points){if(4!==points.length)throw"Croppie - Invalid number of points supplied: "+points;var self=this,pointsWidth=points[2]-points[0],vpData=this.elements.viewport.getBoundingClientRect(),boundRect=this.elements.boundary.getBoundingClientRect(),vpOffset_left=vpData.left-boundRect.left,vpOffset_top=vpData.top-boundRect.top,scale=vpData.width/pointsWidth,originTop=points[1],originLeft=points[0],transformTop=-1*points[1]+vpOffset_top,transformLeft=-1*points[0]+vpOffset_left,newCss={};newCss[CSS_TRANS_ORG]=originLeft+"px "+originTop+"px",newCss[CSS_TRANSFORM]=new Transform(transformLeft,transformTop,scale).toString(),css(this.elements.preview,newCss),_setZoomerVal.call(this,scale),this._currentZoom=scale}function _centerImage(){var self=this,imgDim=this.elements.preview.getBoundingClientRect(),vpDim=this.elements.viewport.getBoundingClientRect(),boundDim=this.elements.boundary.getBoundingClientRect(),vpLeft=vpDim.left-boundDim.left,vpTop=vpDim.top-boundDim.top,w=vpLeft-(imgDim.width-vpDim.width)/2,h=vpTop-(imgDim.height-vpDim.height)/2,transform=new Transform(w,h,this._currentZoom);css(this.elements.preview,CSS_TRANSFORM,transform.toString())}function _transferImageToCanvas(customOrientation){var self=this,canvas=this.elements.canvas,img=this.elements.img,ctx,orientation;canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height),canvas.width=img.width,canvas.height=img.height,drawCanvas(canvas,img,this.options.enableOrientation&&customOrientation||getExifOrientation(img))}function _getCanvas(data){var self=this,points=data.points,left=num(points[0]),top=num(points[1]),right,bottom,width=num(points[2])-left,height=num(points[3])-top,circle=data.circle,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),startX=0,startY=0,canvasWidth=data.outputWidth||width,canvasHeight=data.outputHeight||height;canvas.width=canvasWidth,canvas.height=canvasHeight,data.backgroundColor&&(ctx.fillStyle=data.backgroundColor,ctx.fillRect(0,0,canvasWidth,canvasHeight));var sx=left,sy=top,sWidth=width,sHeight=height,dx=0,dy=0,dWidth=canvasWidth,dHeight=canvasHeight;return left<0&&(sx=0,dx=Math.abs(left)/width*canvasWidth),sWidth+sx>this._originalImageWidth&&(dWidth=(sWidth=this._originalImageWidth-sx)/width*canvasWidth),top<0&&(sy=0,dy=Math.abs(top)/height*canvasHeight),sHeight+sy>this._originalImageHeight&&(dHeight=(sHeight=this._originalImageHeight-sy)/height*canvasHeight),ctx.drawImage(this.elements.preview,sx,sy,sWidth,sHeight,dx,dy,dWidth,dHeight),circle&&(ctx.fillStyle="#fff",ctx.globalCompositeOperation="destination-in",ctx.beginPath(),ctx.arc(canvas.width/2,canvas.height/2,canvas.width/2,0,2*Math.PI,!0),ctx.closePath(),ctx.fill()),canvas}function _getHtmlResult(data){var points=data.points,div=document.createElement("div"),img=document.createElement("img"),width=points[2]-points[0],height=points[3]-points[1];return addClass(div,"croppie-result"),div.appendChild(img),css(img,{left:-1*points[0]+"px",top:-1*points[1]+"px"}),img.src=data.url,css(div,{width:width+"px",height:height+"px"}),div}function _getBase64Result(data){return _getCanvas.call(this,data).toDataURL(data.format,data.quality)}function _getBlobResult(data){var self=this;return new Promise((function(resolve){_getCanvas.call(self,data).toBlob((function(blob){resolve(blob)}),data.format,data.quality)}))}function _replaceImage(img){this.elements.img.parentNode&&(Array.prototype.forEach.call(this.elements.img.classList,(function(c){img.classList.add(c)})),this.elements.img.parentNode.replaceChild(img,this.elements.img),this.elements.preview=img),this.elements.img=img}function _bind(options,cb){var self=this,url,points=[],zoom=null,hasExif=_hasExif.call(self);if("string"==typeof options)url=options,options={};else if(Array.isArray(options))points=options.slice();else{if(void 0===options&&self.data.url)return _updatePropertiesFromImage.call(self),_triggerUpdate.call(self),null;url=options.url,points=options.points||[],zoom=void 0===options.zoom?null:options.zoom}return self.data.bound=!1,self.data.url=url||self.data.url,self.data.boundZoom=zoom,loadImage(url,hasExif).then((function(img){if(_replaceImage.call(self,img),points.length)self.options.relative&&(points=[points[0]*img.naturalWidth/100,points[1]*img.naturalHeight/100,points[2]*img.naturalWidth/100,points[3]*img.naturalHeight/100]);else{var natDim=naturalImageDimensions(img),rect=self.elements.viewport.getBoundingClientRect(),aspectRatio=rect.width/rect.height,imgAspectRatio,width,height;natDim.width/natDim.height>aspectRatio?width=(height=natDim.height)*aspectRatio:(width=natDim.width,height=natDim.height/aspectRatio);var x0=(natDim.width-width)/2,y0=(natDim.height-height)/2,x1=x0+width,y1=y0+height;self.data.points=[x0,y0,x1,y1]}self.data.orientation=options.orientation||1,self.data.points=points.map((function(p){return parseFloat(p)})),self.options.useCanvas&&_transferImageToCanvas.call(self,self.data.orientation),_updatePropertiesFromImage.call(self),_triggerUpdate.call(self),cb&&cb()}))}function fix(v,decimalPoints){return parseFloat(v).toFixed(decimalPoints||0)}function _get(){var self=this,imgData=this.elements.preview.getBoundingClientRect(),vpData=this.elements.viewport.getBoundingClientRect(),x1=vpData.left-imgData.left,y1=vpData.top-imgData.top,widthDiff=(vpData.width-this.elements.viewport.offsetWidth)/2,heightDiff=(vpData.height-this.elements.viewport.offsetHeight)/2,x2=x1+this.elements.viewport.offsetWidth+widthDiff,y2=y1+this.elements.viewport.offsetHeight+heightDiff,scale=this._currentZoom;(scale===1/0||isNaN(scale))&&(scale=1);var max=this.options.enforceBoundary?0:Number.NEGATIVE_INFINITY;return x1=Math.max(max,x1/scale),y1=Math.max(max,y1/scale),x2=Math.max(max,x2/scale),y2=Math.max(max,y2/scale),{points:[fix(x1),fix(y1),fix(x2),fix(y2)],zoom:scale,orientation:this.data.orientation}}var RESULT_DEFAULTS={type:"canvas",format:"png",quality:1},RESULT_FORMATS=["jpeg","webp","png"];function _result(options){var self=this,data=_get.call(self),opts=deepExtend(clone(RESULT_DEFAULTS),clone(options)),resultType="string"==typeof options?options:opts.type||"base64",size=opts.size||"viewport",format=opts.format,quality=opts.quality,backgroundColor=opts.backgroundColor,circle="boolean"==typeof opts.circle?opts.circle:"circle"===self.options.viewport.type,vpRect=self.elements.viewport.getBoundingClientRect(),ratio=vpRect.width/vpRect.height,prom;return"viewport"===size?(data.outputWidth=vpRect.width,data.outputHeight=vpRect.height):"object"==typeof size&&(size.width&&size.height?(data.outputWidth=size.width,data.outputHeight=size.height):size.width?(data.outputWidth=size.width,data.outputHeight=size.width/ratio):size.height&&(data.outputWidth=size.height*ratio,data.outputHeight=size.height)),RESULT_FORMATS.indexOf(format)>-1&&(data.format="image/"+format,data.quality=quality),data.circle=circle,data.url=self.data.url,data.backgroundColor=backgroundColor,prom=new Promise((function(resolve){switch(resultType.toLowerCase()){case"rawcanvas":resolve(_getCanvas.call(self,data));break;case"canvas":case"base64":resolve(_getBase64Result.call(self,data));break;case"blob":_getBlobResult.call(self,data).then(resolve);break;default:resolve(_getHtmlResult.call(self,data))}}))}function _refresh(){_updatePropertiesFromImage.call(this)}function _rotate(deg){if(!this.options.useCanvas||!this.options.enableOrientation)throw"Croppie: Cannot rotate without enableOrientation && EXIF.js included";var self=this,canvas=this.elements.canvas;if(this.data.orientation=getExifOffset(this.data.orientation,deg),drawCanvas(canvas,this.elements.img,this.data.orientation),_updateCenterPoint.call(this,!0),_updateZoomLimits.call(this),Math.abs(deg)/90%2==1){var oldHeight=this._originalImageHeight,oldWidth=this._originalImageWidth;this._originalImageWidth=oldHeight,this._originalImageHeight=oldWidth}}function _destroy(){var self=this;this.element.removeChild(this.elements.boundary),removeClass(this.element,"croppie-container"),this.options.enableZoom&&this.element.removeChild(this.elements.zoomerWrap),delete this.elements}if("undefined"!=typeof window&&window.jQuery){var $=window.jQuery;$.fn.croppie=function(opts){var ot=typeof opts;if("string"===ot){var args=Array.prototype.slice.call(arguments,1),singleInst=$(this).data("croppie");return"get"===opts?singleInst.get():"result"===opts?singleInst.result.apply(singleInst,args):"bind"===opts?singleInst.bind.apply(singleInst,args):this.each((function(){var i=$(this).data("croppie");if(i){var method=i[opts];if(!$.isFunction(method))throw"Croppie "+opts+" method not found";method.apply(i,args),"destroy"===opts&&$(this).removeData("croppie")}}))}return this.each((function(){var i=new Croppie(this,opts);i.$=$,$(this).data("croppie",i)}))}}function Croppie(element,opts){if(element.className.indexOf("croppie-container")>-1)throw new Error("Croppie: Can't initialize croppie more than once");if(this.element=element,this.options=deepExtend(clone(Croppie.defaults),opts),"img"===this.element.tagName.toLowerCase()){var origImage=this.element;addClass(origImage,"cr-original-image"),setAttributes(origImage,{"aria-hidden":"true",alt:""});var replacementDiv=document.createElement("div");this.element.parentNode.appendChild(replacementDiv),replacementDiv.appendChild(origImage),this.element=replacementDiv,this.options.url=this.options.url||origImage.src}if(_create.call(this),this.options.url){var bindOpts={url:this.options.url,points:this.options.points};delete this.options.url,delete this.options.points,_bind.call(this,bindOpts)}}return Croppie.defaults={viewport:{width:100,height:100,type:"square"},boundary:{},orientationControls:{enabled:!0,leftClass:"",rightClass:""},resizeControls:{width:!0,height:!0},customClass:"",showZoomer:!0,enableZoom:!0,enableResize:!1,mouseWheelZoom:!0,enableExif:!1,enforceBoundary:!0,enableOrientation:!1,enableKeyMovement:!0,update:function(){}},Croppie.globals={translate:"translate3d"},deepExtend(Croppie.prototype,{bind:function(options,cb){return _bind.call(this,options,cb)},get:function(){var data=_get.call(this),points=data.points;return this.options.relative&&(points[0]/=this.elements.img.naturalWidth/100,points[1]/=this.elements.img.naturalHeight/100,points[2]/=this.elements.img.naturalWidth/100,points[3]/=this.elements.img.naturalHeight/100),data},result:function(type){return _result.call(this,type)},refresh:function(){return _refresh.call(this)},setZoom:function(v){_setZoomerVal.call(this,v),dispatchChange(this.elements.zoomer)},rotate:function(deg){_rotate.call(this,deg)},destroy:function(){return _destroy.call(this)}}),Croppie}));